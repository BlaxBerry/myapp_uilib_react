import { Meta, Title, Subtitle, Controls, Story } from "@storybook/blocks";
import * as Stories from "./index.stories";

<Meta of={Stories} />

<Title>\<FileUploadHiddenInput></Title>

<Subtitle>不显示的文件上传表单</Subtitle>

```tsx
import {
  FileUploadHiddenInput,
  type FileUploadHiddenInputProps,
  type FileUploadFinishHandler,
  type FileUploadResult,
} from "myapp_uilib_react";
```

<Controls />

## 基本使用

因为该组件不会在页面上展示，可结合`<button>`+`<label>`实现文件上传功能

<div className="my-code-block">
  <Story of={Stories.BaseExample} />
</div>

```tsx
import { useCallback } from "react";
import {
  // BaseButton,
  FileUploadHiddenInput,
  type FileUploadFinishHandler,
} from "myapp_uilib_react";

function App() {
  const handleFinish: FileUploadFinishHandler = useCallback((result) => {
    console.log(result);
  }, []);

  return (
    <button>
      <label>
        上传
        <FileUploadHiddenInput handleFinish={handleFinish} />
      </label>
    </button>

    // <BaseButton component="label">
    //   上传
    //   <FileUploadHiddenInput handleFinish={handleFinish} />
    // </BaseButton>
  );
}
```

## 上传文件信息

`props.handleFinish`回调函数的参数可结构获取上传的文件列表，只有一个文件时也是包含在一个列表内

<div className="my-code-block">
  <Story of={Stories.UploadedFilesExample} />
</div>

```tsx
import { useCallback, useState, useMemo } from "react";
import {
  FileUploadHiddenInput,
  type FileUploadFinishHandler,
} from "myapp_uilib_react";

function App() {
  const [uploadedFiles, setUploadedFiles] = useState<FileList | null>(null);

  const handleFinish: FileUploadFinishHandler = useCallback(
    ({ files }) => {
      if (files) setUploadedFiles(files);
    },
    [setUploadedFiles],
  );

  const fileTarget = useMemo<File | null>(() => {
    if (uploadedFiles?.length === 1) return uploadedFiles[0];
    else return null;
  }, [uploadedFiles]);

  return (
    <>
      <button>
        <label>
          上传
          <FileUploadHiddenInput multiple handleFinish={handleFinish} />
        </label>
      </button>

      <small>
        {!uploadedFilesLength
          ? "未选择任何文件"
          : uploadedFilesLength > 1
            ? `已选择${uploadedFiles?.length}个文件`
            : fileTarget &&
              `${fileTarget?.name} ${Math.floor(fileTarget?.size / 1000)}KB`}
      </small>
    </>
  );
}
```

## 预览上传的图片

结合 FileReader 对上传的图片进行预览

- `props.accept`建议为`image/*`
- 按需指定`props.multiple`，本例子为限定只能上传一个文件

  <Story of={Stories.PreviewImageExample} />

```tsx
import { useCallback, useState, useMemo } from "react";
import {
  FileUploadHiddenInput,
  type FileUploadFinishHandler,
} from "myapp_uilib_react";

function App() {
  const [file, setFile] = React.useState<File>();
  const [imgSrc, setImgSrc] = React.useState<string | ArrayBuffer>();

  const handleFinish: FileUploadFinishHandler = React.useCallback(
    ({ files }) => {
      const file = files?.[0];
      setFile(file);

      if (file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          const readResult = e.target?.result;
          if (readResult) {
            setImgSrc(readResult);
          }
        };
      }
    },
    [setFile, setImgSrc],
  );

  return (
    <>
      <button>
        <label>
          上传图片
          <FileUploadHiddenInput
            accept="image/*"
            multiple={false}
            handleFinish={handleFinish}
          />
        </label>
      </button>

      <img
        src={imgSrc as string}
        alt={file?.name}
        loading="lazy"
        style={{
          display: "block",
          width: "200px",
          height: "200px",
          border: "1px solid black",
        }}
      />
      <small style={{ height: "1rem" }}>{file?.name}</small>
    </>
  );
}
```

### 限制上传文件的尺寸

```tsx
import { useCallback, useState, useMemo } from "react";
import {
  FileUploadHiddenInput,
  type FileUploadFinishHandler,
} from "myapp_uilib_react";

function App() {
  const [files, setFiles] = useState<FileList>();
  const [limitSizeError, setLimitSizeError] =
    useState<FileUploadResult["limitSizeError"]>(null);

  const filesLength = files?.length || 0;

  const handleFinish: FileUploadFinishHandler = useCallback(
    ({ files, limitSizeError }) => {
      if (files) {
        setFiles(files);
      }

      if (limitSizeError) {
        setLimitSizeError(limitSizeError);
      } else {
        setLimitSizeError(null);
      }
    },
    [setFiles, setLimitSizeError],
  );

  return (
    <>
      <button>
        <label>
          上传图片
          <FileUploadHiddenInput
            multiple
            limitSize={1048576} // 1MB
            handleFinish={handleFinish}
          />
        </label>
      </button>

      {!limitSizeError && files && (
        <p style={{ color: "green" }}>
          {filesLength > 1 ? (
            <small>{`成功上传${filesLength}个文件`}</small>
          ) : (
            <>
              <small>{files?.[0]?.name}</small>
              <br />
              <small>{files?.[0]?.size}</small>
            </>
          )}
        </p>
      )}

      {limitSizeError && (
        <p style={{ color: "red" }}>
          <small>{`上传失败的文件：${limitSizeError.inValidFile.name} ( ${limitSizeError.inValidFile.size} 字节 )`}</small>
        </p>
      )}
    </>
  );
}
```

<style>
  {`
    /* personal code block */
    .my-code-block {
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  `}
</style>
